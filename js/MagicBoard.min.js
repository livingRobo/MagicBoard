var inheritsFrom=function(e,t){e.prototype=Object.create(t.prototype)},MagicBoard={sheetBook:null,indicators:{mouseDown:!1,mouseover:[],click:!1,doubleClick:0,resize:-1},boardPos:{x:0,y:0},theme:{sheetBackground:null,shapeColor:"#1b8d11",arrowFillColor:"#1b8d11",borderColor:"white",lineColor:"#1b8d11",textColor:"white"},scratch:{path:[]}};MagicBoard.properties={"background-color":{propType:"attribute",propName:"fill",label:"Background Color",field:"input",values:[{name:"",value:MagicBoard.theme.shapeColor,type:"color"}]},"border-color":{propName:"stroke",propType:"attribute",label:"Border Color",field:"input",values:[{name:"",value:MagicBoard.theme.shapeColor,type:"color"}]},"border-width":{propName:"stroke-width",propType:"attribute",label:"Border Width",field:"input",values:[{name:"",value:"1",type:"text"}]},"border-style":{propName:"stroke-dasharray",propType:"attribute",label:"Border Style",field:"select",values:[{name:"Dash",value:"5,5",type:""},{name:"Solid",value:"",type:""},{name:"Dotted",value:"1,1",type:""}]},text:{propName:"innerHTML",propType:"dom",label:"Text",field:"input",values:[{name:"",value:"",type:"text"}]},"text-color":{propName:"fill",propType:"attribute",label:"Text Color",field:"input",values:[{name:"",value:"#ffffff",type:"color"}]},"font-size":{propName:"font-size",propType:"attribute",label:"Font Color",field:"input",values:[{name:"",value:"14",type:"text"}]},"font-weight":{propName:"font-weight",propType:"attribute",label:"Font Weight",field:"select",values:[{name:"Regular",value:"regular"},{name:"Bold",value:"bold"},{name:"Italic",value:"italic"}]},"text-content":{propName:"innerHTML",propType:"dom",label:"Text",field:"input",values:[{value:""}]},"line-type":{propName:"",propType:"function",field:"select",label:"Line Type",values:[{name:"Straight",value:"straight"},{name:"Zig Zag",value:"zig-zag"},{name:"Brezier Curve",value:"brezier"},{name:"Quadratic Curve",value:"quadratic"}]},"line-color":{propName:"stroke",propType:"attribute",label:"Line Color",field:"input",values:[{name:"",value:MagicBoard.theme.shapeColor,type:"color"}]},"line-width":{propName:"stroke-width",propType:"attribute",label:"Line Width",field:"input",values:[{name:"",value:"1",type:"text"}]},"line-style":{propName:"stroke-dasharray",propType:"attribute",label:"Line Style",field:"select",values:[{name:"Solid",value:"",type:""},{name:"Dash",value:"5,5",type:""},{name:"Dotted",value:"1,1",type:""}]},"end-marker":{propName:"marker-end",propType:"attribute",label:"End Marker",field:"select",values:[{name:"Filled Arrow",value:"url(#fillArrowE)"},{name:"Hollow Arrow",value:"url(#hollowArrowE)"},{name:"Regular Arrow",value:"url(#lineArrowE)"},{name:"Cicle",value:"url(#dot)"},{name:"Hollow Diamond",value:"url(#hollowDiamond)"},{name:"Filled Diamond",value:"url(#fillDiamond)"},{name:"No Arrow",value:""}]},"start-marker":{propName:"marker-start",propType:"attribute",label:"Start Marker",field:"select",values:[{name:"Filled Arrow",value:"url(#fillArrowS)"},{name:"Hollow Arrow",value:"url(#hollowArrowS)"},{name:"Regular Arrow",value:"url(#lineArrowS)"},{name:"Cicle",value:"url(#dot)"},{name:"Hollow Diamond",value:"url(#hollowDiamond)"},{name:"Filled Diamond",value:"url(#fillDiamond)"},{name:"No Arrow",value:""}]},"mid-marker":{propName:"marker-mid",propType:"attribute",field:"select",label:"Mid Marker",values:[{name:"Dot",value:"url(#dot)"}]}};var SheetBook=function(e,t,i){this.cheight=400,this.cwidth=400,this.sheets=[],this.currentSheet=null,this.anchor=document.body,this.zoomPercent=100,this.zoomCompensate=1,this.alignments={x:[],y:[]},this.maxRedo=5,this.garbage=document.createElement("div"),this.garbage.setAttribute("style","display:none"),document.body.appendChild(this.garbage),i&&(this.cheight=i),t&&(this.cwidth=t),e&&(this.anchor=e);var r=e.getBoundingClientRect();MagicBoard.boardPos={x:r.left,y:r.top},Utility.SheetBook.createWorkItems(this),document.onmousedown=function(e){return MagicBoard.eventStart(e)},document.onmousemove=function(e){MagicBoard.eventContinue(e)},document.onmouseup=function(e){MagicBoard.eventStop(e)},document.onkeyup=function(e){event.preventDefault(),MagicBoard.keyUp(e)},document.onscroll=function(){var e=MagicBoard.sheetBook.anchor.getBoundingClientRect();MagicBoard.boardPos={x:e.left,y:e.top}}};SheetBook.prototype.zoom=function(e){this.zoomPercent=e,this.anchor.style.zoom=e/100,this.zoomCompensate=1+(100-e)/100},SheetBook.prototype.setAnchorElement=function(e){this.anchor=e},SheetBook.prototype.addSheet=function(e){this.sheets.push(e);var t=e.getCanvas();t.setAttribute("height",this.cheight),t.setAttribute("width",this.cwidth),t.style.width=this.cwidth+"px",t.style.height=this.cheight+"px",this.anchor.appendChild(t),this.setCurrentSheet(e)},SheetBook.prototype.getSheet=function(e){for(var t=this.sheets.length-1;t>-1;t--){var i=this.sheets[t];if(i.name===e)return i}return null},SheetBook.prototype.getCurrentSheet=function(){return this.currentSheet},SheetBook.prototype.setCurrentSheet=function(e){var t=null,i=!1;"string"==typeof e&&(t=e,i=!0);for(var r=this.sheets.length-1;r>-1;r--){var o=this.sheets[r];o.canvas.style.visibility="hidden",i?o.name===t&&(this.currentSheet=e):o===e&&(this.currentSheet=e)}e.canvas.style.visibility="visible";var a=this.connectCanvas;MagicBoard.sheetBook.connectCtx.clearRect(0,0,a.width,a.height)},SheetBook.prototype.getCombinedImage=function(){var e=this.scratchCtx;if(e){e.clearRect(0,0,this.cwidth,this.cheight);for(var t=this.shapes.length,i=0;t>i;i++){var r=this.shapes[i];r.draw(e)}var o=this.scratchCanvas.toDataURL();return o}},SheetBook.prototype.setHeight=function(e){this.cheight=e,this.currentCanvas.setAttribute("height",this.cheight)},SheetBook.prototype.setWidth=function(e){this.cwidth=e,this.currentCanvas.setAttribute("width",e)};var Sheet=function(e){this.options={},e&&(this.options=e),this.name="Sheet1",e.name&&(this.name=e.name),this.canvas=null,this.init()};Sheet.prototype.init=function(){this.removedShapes=[],this.canvas=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.canvas.setAttribute("id",this.name),this.canvas.style.position="absolute",this.canvas.style.left="0px",this.canvas.style.top="0px",this.canvas.style["z-index"]="1",this.canvas.setAttribute("name","mg"),this.canvas.style.visibility="visible";var e=this.options["background-color"];e&&(this.canvas.style.fill=e),this.connections=[],Utility.Sheet.Markers(this),this.courseGridSize={x:100,y:100},this.noOfXcourseGrids=Math.floor(MagicBoard.sheetBook.cwidth/this.courseGridSize.x),this.noOfYcourseGrids=Math.floor(MagicBoard.sheetBook.cheight/this.courseGridSize.y),this.courseGrids=[];for(var t=0,i=0;i<this.noOfYcourseGrids;i++)for(var r=i*this.courseGridSize.y,o=(i+1)*this.courseGridSize.y,a=0;a<this.noOfXcourseGrids;a++){var n=a*this.courseGridSize.x,s=(a+1)*this.courseGridSize.x,h={filled:!1,shapes:[],x1:n,x2:s,y1:r,y2:o,index:t++};this.courseGrids.push(h)}if(MagicBoard.sheetBook.currentSheet=this,this.shapes=[],this.options.shapes)for(var l=0,c=this.options.shapes.length;c>l;l++){var p=new Shape(this.options.shapes[l]);p.draw(),p.setPosition({x:p.dimension.left,y:p.dimension.top})}},Sheet.prototype.getCanvas=function(){return this.canvas},Sheet.prototype.rename=function(e){this.name=e,this.options.name=e},Sheet.prototype.wipe=function(){for(var e=MagicBoard.sheetBook.garbage,t=this.canvas.children,i=t.length-1;i>-1;i--){var r=t[i];"workItem"!==r.getAttribute("name")&&e.appendChild(r)}e.innerHTML=""},Sheet.prototype.totalShapeArea=function(){},Sheet.prototype.addShape=function(e){this.shapes.push(e)},Sheet.prototype.removeLastShape=function(){var e=MagicBoard.sheetBook.maxRedo;if(0!==this.shapes.length){var t=this.shapes[this.shapes.length-1];this.removedShapes.push(t),this.removedShapes.length>e&&this.removedShapes.splice(0,1),this.shapes.pop()}},Sheet.prototype.removeShape=function(e){if(0!==this.shapes.length)for(var t=this.shapes.length-1;t>-1;t--){var i=this.shapes[t];if(i===e)return void this.shapes.splice(t,1)}},Sheet.prototype.reDraw=function(){this.wipe();for(var e=this.shapes.length,t=0;e>t;t++){var i=this.shapes[t];i.createCanvas(),i.draw()}},Sheet.prototype.undo=function(){this.removeLastShape(),this.reDraw()},Sheet.prototype.redo=function(){0!==this.removedShapes.length&&(this.shapes.push(this.removedShapes[0]),this.removedShapes.splice(0,1),this.reDraw())},Sheet.prototype.refreshConnections=function(){for(var e=this.shapes.length,t=0;e>t;t++){var i=this.shapes[t];i.refreshConnection()}},Sheet.prototype.getImage=function(e){for(var t=this.canvas.cloneNode(),i=this.shapes,r=i.length,o=9999,a=9999,n=0,s=0,h=0;r>h;h++){var l=i[h],c=l.drawSVG();t.appendChild(c);var p=l.frame;p.left<o&&(o=p.left),p.top<a&&(a=p.top),p.right>n&&(n=p.right),p.bottom>s&&(s=p.bottom)}n+=10,s+=10,t.setAttribute("x",0),t.setAttribute("y",0),t.setAttribute("width",n),t.setAttribute("height",s),t.style.width=n+"px",t.style.height=s+"px";var d=new XMLSerializer,m=d.serializeToString(t);if("svg"===e)return{dataURL:m,size:{width:n,height:s}};var g=document.createElement("IMG");g.src="data:image/svg+xml;utf8,"+encodeURI(m);var y=document.createElement("canvas");y.height=s,y.width=n;var u=y.getContext("2d");u.drawImage(g,0,0,y.width,y.height);var v=y.toDataURL();return{dataURL:v,size:{width:y.width,height:y.height}}},Sheet.prototype.getConnection=function(e,t){for(var i=this.connections,r=i.length,o=0;r>o;o++){var a=i[o];if(a.beginShape===e&&a.endShape===t)return a}},Sheet.prototype.addConnections=function(e){for(var t=e.beginShape,i=e.endShape,r=this.connections,o=r.length,a=!1,n=0;o>n;n++){var s=r[n],h=e.pos;if(s.beginShape===t&&s.endShape===i)return a=!0,s.pos=h,s.orientation=e.orientation,s}return a||r.push(e),e},Sheet.prototype.findShapeByPosition=function(e){for(var t=[],i=0,r=this.shapes.length;r>i;i++){var o=this.shapes[i];o.contains(e)&&t.push(o)}return t},Sheet.prototype.save=function(){var e={};e.options=this.options,e.shapes=[];for(var t=0,i=this.shapes.length;i>t;t++){var r=this.shapes[t],o=r.save();o&&e.shapes.push(o)}return e},Sheet.prototype.changeThemeColor=function(e,t,i,r,o){e&&(MagicBoard.theme.backgroundColor=e),t&&(MagicBoard.theme.shapeColor=t),i&&(MagicBoard.theme.arrowFillColor=i),r&&(MagicBoard.theme.borderColor=r),o&&(MagicBoard.theme.lineColor=o);for(var a=0,n=this.shapes.length;n>a;a++){var s=this.shapes[a];s.changeThemeColor(t,r,o)}},Sheet.prototype.removeConnections=function(e){for(var t=e.connectedFrom,i=(t.length,0);a>i;i++){var r=t[i];Utility.Sheet.removeConnection(this,r,e)}for(var o=e.connectedTo,a=o.length,n=0;a>n;n++){var s=o[n];Utility.Sheet.removeConnection(this,e,s)}},Sheet.prototype.drawConnections=function(e){e||setTimeout(function(){Utility.SheetBook.clearScratchCanvas()},700);for(var t=this.connections,i=t.length,r=0;i>r;r++){var o=t[r];o.shape&&(o.shape.deleteShape(!0),o.shape=null);var a=new ConnectorLine(o);a.draw()}};var Point=function(e,t){this.x=e,this.y=t},DrawingObject=function(){this.draw=function(){}},Shape=function(e){if(this.param=JSON.parse(JSON.stringify(e.param)),this.frame=JSON.parse(JSON.stringify(e.frame)),e.parent){this.param.alignmentRails=!1,this.param.noGridBlock=!0,this.parentShape=e.parent;var t=this.parentShape.dimension;e.frame.width=t.width-4,e.frame.height>t.height&&(e.frame.height=t.height-4),this.frame.minLeft=t.left,this.frame.maxRight=t.left+t.width,this.frame.minTop=t.top,this.frame.maxBottom=t.top+t.height,this.parentShape.children.push(this)}this.frame.minLeft||(this.frame.minLeft=10,this.frame.maxRight=MagicBoard.sheetBook.cwidth),this.frame.minTop||(this.frame.minTop=10,this.frame.maxBottom=MagicBoard.sheetBook.cheight),e.events?this.events=e.events:this.events={click:{override:null,post:null,pre:null},hover:{override:null,post:null,pre:null},doubleClick:{override:null,post:null,pre:null}},e.connectedFromIds&&(this.connectedFromIds=e.connectedFromIds),e.connectedToIds&&(this.connectedToIds=e.connectedToIds),e.id&&(this.id=e.id),this.properties={},this.components=[];for(var i=e.componentParms.length,r=0;i>r;r++){var o=new ShapeComponent(e.componentParms[r]);this.components.push(o);for(var a in o.properties)this.properties[a]=!0}this.init()};inheritsFrom(Shape,DrawingObject),Shape.prototype.init=function(){this.children||(this.children=[]),this.components||(this.components=[]),void 0==this.param.alignmentRails&&(this.param.alignmentRails=!0),this.occupiedGrids=[],this.currentSheet=MagicBoard.sheetBook.getCurrentSheet(),this.sheetCanvas=this.currentSheet.getCanvas(),this.frame&&this.createCanvas();this.dimension=this.frame,this.id||(this.id=this.currentSheet.shapes.length),this.currentSheet.addShape(this),this.connectedTo=[],this.connectedFrom=[]},Shape.prototype.getShapeDetail=function(){var e={};e.param=this.param,e.frame=this.frame,e.events=this.events,e=JSON.parse(JSON.stringify(e)),e.componentParms=[];for(var t=this.components.length,i=0;t>i;i++){var r=this.components[i],o=r.getComponentDetails();e.componentParms.push(o)}return e},Shape.prototype.createCanvas=function(){var e=Utility.Shape.dataFormatter(this.frame.width,"width",this);this.frame.width=e;var t=Utility.Shape.dataFormatter(this.frame.height,"height",this);this.frame.height=t;var i=document.createElementNS("http://www.w3.org/2000/svg","g");this.dom=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.dom.setAttribute("name","mg"),this.dom.setAttribute("draggable","false"),this.dom.setAttribute("width",e),this.dom.setAttribute("height",t),this.dom.setAttribute("pointer-events","all"),this.dom.setAttribute("style","position:absolute;-ms-user-select:none;-webkit-user-select:none;z-index:10;transform:translate(1.5,1.5);z-index:1"),this.dom.setAttribute("x",Utility.Shape.dataFormatter(this.frame.left,"left",this)),this.dom.setAttribute("y",Utility.Shape.dataFormatter(this.frame.top,"top",this)),i.appendChild(this.dom),this.sheetCanvas.appendChild(i)},Shape.prototype.addComponent=function(e){this.components.push(e)},Shape.prototype.addHover=function(){var e=this,t=this.dom;t.onmouseover=function(){MagicBoard.indicators.mouseover.push(e),MagicBoard.indicators.lineActive===e&&(MagicBoard.scratch.connectToSame=!0)},t.onmouseout=function(){event.preventDefault();for(var t=MagicBoard.indicators.mouseover.length-1;t>-1;t--)if(MagicBoard.indicators.mouseover[t]===e)return void MagicBoard.indicators.mouseover.splice(t,1)}},Shape.prototype.click=function(){var e=this.events;if(e){if(e.click||(e.click={override:null,pre:null,post:null}),e.click.override)return window[e.click.override].call(this);e.click.pre&&window[e.click.pre].call(this)}this.selectToggle()},Shape.prototype.doubleClick=function(){var e=this,t=event.target;if(t instanceof SVGTextElement){var i=t.getBoundingClientRect(),r=MagicBoard.sheetBook.textEditor;r.style.left=i.left-2,r.style.top=i.top-2,r.style.width=i.width+4,r.style.height=i.height+4,r.style.display="block",r.innerHTML=t.innerHTML,r.targetShape=e,r.focus()}},Shape.prototype.move=function(e,t){var i=this.getDimension(),r=e.y-t.y,o=e.x-t.x,a=i.top+r,n=i.bottom+r,s=i.left+o,h=i.right+o,l=MagicBoard.sheetBook.scratchCtx,c=MagicBoard.sheetBook.scratchCanvas;if(MagicBoard.scratch.prevAlign){if(MagicBoard.scratch.prevAlign.top&&(Math.abs(a-MagicBoard.scratch.prevAlign.top)<8?a=MagicBoard.scratch.prevAlign.top:delete MagicBoard.scratch.prevAlign.top),MagicBoard.scratch.prevAlign.left&&(Math.abs(s-MagicBoard.scratch.prevAlign.left)<8?s=MagicBoard.scratch.prevAlign.left:delete MagicBoard.scratch.prevAlign.left),MagicBoard.scratch.prevAlign.bottom)if(Math.abs(n-MagicBoard.scratch.prevAlign.bottom)<8){n=MagicBoard.scratch.prevAlign.bottom;var p=n-i.bottom;a=i.top+p}else delete MagicBoard.scratch.prevAlign.bottom;if(MagicBoard.scratch.prevAlign.right)if(Math.abs(h-MagicBoard.scratch.prevAlign.right)<8){h=MagicBoard.scratch.prevAlign.right;var p=h-i.right;s=i.left+p}else delete MagicBoard.scratch.prevAlign.right;var d=!1;for(var m in MagicBoard.scratch.prevAlign){d=!0;break}d||(delete MagicBoard.scratch.prevAlign,l.clearRect(0,0,c.width,c.height))}else{var d=this.alignmentCheck(l,c.width,c.height,a,s,n,h);d||l.clearRect(0,0,c.width,c.height)}l.beginPath(),l.strokeStyle="green",l.setLineDash([2,2]),l.lineWidth=4,l.rect(s-2,a-2,i.width+4,i.height+4),l.stroke()},Shape.prototype.resizeContinue=function(e,t){var i=(MagicBoard.sheetBook.hilighter,MagicBoard.indicators.resize);if(2>i){var r=e.x-t.x;Utility.Shape.resize(this,r,-1)}else if(4>i){var o=e.y-t.y;Utility.Shape.resize(this,-1,o)}else{var r=e.x-t.x,o=e.y-t.y;Utility.Shape.resize(this,r,o)}Utility.SheetBook.resizeHilighter(this.dimension,this)},Shape.prototype.resizeStop=function(){var e=(MagicBoard.indicators.resizeStarted,MagicBoard.indicators.click,{x:this.dimension.left,y:this.dimension.top},MagicBoard.sheetBook.hilighter);e.style.visibility="hidden",e.style.transform="",this.dom.style.transform="",this.dimension.resizeX=null,this.dimension.resizeY=null,this.dimension.resizeWidth=null,this.dimension.resizeHeight=null,Utility.Shape.definePeriferalPoints(this.dimension),MagicBoard.indicators.resize=-1,MagicBoard.indicators.resizeStarted=null,this.selectToggle()},Shape.prototype.lineTo=function(e){var t=MagicBoard.sheetBook.scratchCtx;t.lineTo(e.x,e.y),t.stroke()},Shape.prototype.refreshConnection=function(e){for(var t=this.currentSheet,i=this.connectedFrom,r=i.length,o=0;r>o;o++){var a=i[o],n=t.getConnection(a,this);Utility.Shape.reCalculateConnectionPoints(n),t.drawConnections(e)}for(var s=this.connectedTo,h=s.length,l=0;h>l;l++){endShape=s[l];var n=t.getConnection(this,endShape);Utility.Shape.reCalculateConnectionPoints(n),t.drawConnections(e)}},Shape.prototype.connectFrom=function(e){for(var t=this.connectedFrom,i=!1,r=t.length,o=0;r>o;o++){var a=t[o];if(e===a){i=!0;break}}i||this.connectedFrom.push(e)},Shape.prototype.connectTo=function(e,t){var i=this.events;if(!t){if(i&&i.connectTo&&i.connectTo.override)return void window[i.connectTo.override].call(this,e);t={type:"TWOBEND",end:"FILLED",begin:null}}Utility.Shape.connectTo(this,e,t)},Shape.prototype.alignmentCheck=function(e,t,i,r,o,a,n,s){var h=!1,l=[];if(MagicBoard.sheetBook.alignments.x[r]&&(l.push("top"),h=!0,MagicBoard.scratch.prevAlign||(MagicBoard.scratch.prevAlign={}),MagicBoard.scratch.prevAlign.top=r),MagicBoard.sheetBook.alignments.x[a]&&(l.push("bottom"),h=!0,MagicBoard.scratch.prevAlign||(MagicBoard.scratch.prevAlign={}),MagicBoard.scratch.prevAlign.bottom=a),MagicBoard.sheetBook.alignments.y[o]&&(l.push("left"),h=!0,MagicBoard.scratch.prevAlign||(MagicBoard.scratch.prevAlign={}),MagicBoard.scratch.prevAlign.left=o),MagicBoard.sheetBook.alignments.y[n]&&(l.push("right"),h=!0,MagicBoard.scratch.prevAlign||(MagicBoard.scratch.prevAlign={}),MagicBoard.scratch.prevAlign.right=n),l.length>0){e.beginPath(),e.strokeStyle="gray",e.lineWidth=1,e.setLineDash([5,5]);for(var c=l.length-1;c>-1;c--){var p=l[c];switch(p){case"top":e.moveTo(0,r),e.lineTo(t,r);break;case"bottom":e.moveTo(0,a),e.lineTo(t,a);break;case"left":e.moveTo(o,0),e.lineTo(o,i);break;case"right":e.moveTo(n,0),e.lineTo(n,i)}}e.stroke(),e.setLineDash([5,0])}return h},Shape.prototype.contains=function(e){var t=this.dimension;return e.x>t.left&&e.x<t.left+t.width&&e.y>t.top&&e.y<t.top+t.height?!0:!1},Shape.prototype.setPosition=function(e,t){this.param.alignmentRails&&this.removeAlignments();var i=this.frame;if(e.diffX&&(i.left&&(e.x=i.left+e.diffX),i.top&&(e.y=i.top+e.diffY),this.parentShape)){var r=this.parentShape.dimension;this.frame.minLeft=r.left,this.frame.maxRight=r.left+r.width,this.frame.minTop=r.top,this.frame.maxBottom=r.top+r.height}e.x<this.frame.minLeft&&(e.x=this.frame.minLeft),e.y<this.frame.minTop&&(e.y=this.frame.minTop),this.frame.maxRight<e.x+i.width&&(e.x=this.frame.maxRight-i.width-5),this.frame.maxBottom<e.y+i.height&&(e.y=this.frame.maxBottom-i.height-5),t&&(e=Utility.Shape.align(e)),this.dom.setAttribute("x",e.x),this.dom.setAttribute("y",e.y),i.left=e.x,i.top=e.y,Utility.Shape.definePeriferalPoints(i),this.refreshConnection(),this.param.alignmentRails&&this.addAlignments(),this.param.noGridBlock||Utility.Shape.blockGrids(this);for(var o=0,a=this.children.length;a>o;o++){var n=this.children[o];n.setPosition(e)}},Shape.prototype.setDimension=function(e){this.dimension={left:e.left,right:e.right,top:e.top,bottom:e.bottom,width:e.width,height:e.height},this.addAlignments()},Shape.prototype.removeAlignments=function(){var e=function(e,t){if(!e)return!1;var i=e.length;if(2>i)return!1;for(var r=i-1;r>-1;r--){var o=e[r];if(o===t)return void e.splice(r,1)}},t=this.dimension,i=e(MagicBoard.sheetBook.alignments.y[t.left],this);i||(MagicBoard.sheetBook.alignments.y[t.left]=null),i=e(MagicBoard.sheetBook.alignments.y[t.right],this),i||(MagicBoard.sheetBook.alignments.y[t.right]=null),i=e(MagicBoard.sheetBook.alignments.y[t.cx],this),i||(MagicBoard.sheetBook.alignments.y[t.cx]=null),i=e(MagicBoard.sheetBook.alignments.x[t.top],this),i||(MagicBoard.sheetBook.alignments.x[t.top]=null),i=e(MagicBoard.sheetBook.alignments.x[t.bottom],this),i||(MagicBoard.sheetBook.alignments.x[t.bottom]=null),i=e(MagicBoard.sheetBook.alignments.x[t.cy],this),i||(MagicBoard.sheetBook.alignments.x[t.cy]=null)},Shape.prototype.addAlignments=function(){var e=this.dimension;MagicBoard.sheetBook.alignments.y[e.left]||(MagicBoard.sheetBook.alignments.y[e.left]=[]),MagicBoard.sheetBook.alignments.y[e.left].push(this),MagicBoard.sheetBook.alignments.y[e.right]||(MagicBoard.sheetBook.alignments.y[e.right]=[]),MagicBoard.sheetBook.alignments.y[e.right].push(this),MagicBoard.sheetBook.alignments.y[e.cx]||(MagicBoard.sheetBook.alignments.y[e.cx]=[]),MagicBoard.sheetBook.alignments.y[e.cx].push(this),MagicBoard.sheetBook.alignments.x[e.top]||(MagicBoard.sheetBook.alignments.x[e.top]=[]),MagicBoard.sheetBook.alignments.x[e.top].push(this),MagicBoard.sheetBook.alignments.x[e.bottom]||(MagicBoard.sheetBook.alignments.x[e.bottom]=[]),MagicBoard.sheetBook.alignments.x[e.bottom].push(this),MagicBoard.sheetBook.alignments.x[e.cy]||(MagicBoard.sheetBook.alignments.x[e.cy]=[]),MagicBoard.sheetBook.alignments.x[e.cy].push(this)},Shape.prototype.getDimension=function(e){return this.dimension||this.setDimension(this.dom.getBoundingClientRect()),this.dimension},Shape.prototype.applyProperty=function(e,t,i,r,o,a){for(var n=0,s=this.components.length;s>n;n++){var h=this.components[n],l=h.properties[e];l&&l.label===o&&l.group===a&&h.applyProperty(t,i,r,o,a)}},Shape.prototype.getProperties=function(){for(var e=[],t=0,i=this.components.length;i>t;t++){var r=this.components[t];for(var o in r.properties){var a=JSON.parse(JSON.stringify(MagicBoard.properties[o])),n=r.properties[o];a.group=n.group,a.label=n.label,a.keyName=o;var s=r.param[a.propName];if("text"===o&&(s=r.innerHTML),s)if("input"===a.field)a.values[0].value=s;else if("select"===a.field)for(var h=0,l=a.values.length;l>h;h++)a.values[h].value==s&&(a.values[h].selected=!0);e[e.length]=a}}return e},Shape.prototype.getDom=function(){return this.dom},Shape.prototype.setPoints=function(e){this.points=e},Shape.prototype.getArea=function(){},Shape.prototype.deleteShape=function(){MagicBoard.sheetBook.currentSheet.removeShape(this);var e=MagicBoard.sheetBook.garbage,t=this.dom.parentNode;e.appendChild(t),e.innerHTML="";for(var i in this)if("object"==typeof this[i]){if("connectedTo"===i){this.connectedTo;MagicBoard.sheetBook.currentSheet.removeConnections(this),MagicBoard.sheetBook.currentSheet.drawConnections()}else"connectedFrom"===i&&(MagicBoard.sheetBook.currentSheet.removeConnections(this),MagicBoard.sheetBook.currentSheet.drawConnections());this[i]=null}},Shape.prototype.selectToggle=function(){var e=this.getDimension(),t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height);var r=MagicBoard.sheetBook.hilighter;if(MagicBoard.indicators.hilight)r.style.visibility="hidden",setTimeout(function(){var e=MagicBoard.indicators.hilight;MagicBoard.indicators.hilight=!1,e.events.click.post&&window[e.events.click.post].call(e)},1),this.addAlignments();else{var o=e.left,a=e.top;this.parentShape;Utility.SheetBook.activateHilighter({left:o,top:a,width:e.width,height:e.height},this),MagicBoard.indicators.hilight=this,this.removeAlignments(),this.events.click.post&&window[this.events.click.post].call(this)}},Shape.prototype.updateText=function(e,t){void 0==t&&(t=0);for(var i=0,r=0,o=this.components.length;o>r;r++){var a=this.components[r];if("text"===a.type){if(i===t){a.updateText(e);break}i++}}},Shape.prototype.save=function(){var e={};for(var t in this)if("cInfo"!==t)if("components"!==t)if("connectedFrom"!==t&&"connectedTo"!==t){var i=this[t].constructor.name;("Number"===i||"String"===i||"Object"===i)&&(e[t]=this[t])}else{e[t+"Ids"]=[];for(var r=this[t].length,o=0;r>o;o++){var a=this[t][o];e[t+"Ids"].push(a.id)}}else{e.componentParms=[];for(var r=this.components.length,o=0;r>o;o++){var n=this.components[o];e.componentParms.push(n.save())}}return e},Shape.prototype.draw=function(){var e=this.dom;e.innerHTML="";var t=document.createElementNS("http://www.w3.org/2000/svg","g");e.appendChild(t),this.reDraw(t);for(var i=this.components.length,r=0;i>r;r++){var o=this.components[r];o.parentShape=this;var a=o.construct();a&&t.appendChild(a)}var n=this.events;n&&n.hover&&n.hover.override?window[n.hover.override].call(this):this.addHover()},Shape.prototype.reDraw=function(e){var t=!0;e||(e=this.dom.firstElementChlid,t=!1);for(var i=this.components.length,r=0;i>r;r++){var o=this.components[r];o.parentShape=this;var a=o.construct();t&&a&&e.appendChild(a)}this.refreshConnection()},Shape.prototype.drawOnCanvas=function(e){e.beginPath();for(var t=this.components.length,i=0;t>i;i++){var r=this.components[i];r.drawOnCanvas(e)}e.stroke(),this.refreshConnection(e)},Shape.prototype.drawSVG=function(){for(var e=document.createElementNS("http://www.w3.org/2000/svg","g"),t=this.frame.left,i=this.frame.top,r=this.components.length,o=0;r>o;o++){var a=this.components[o],n=a.drawSVG(t,i);e.appendChild(n)}return e},Shape.prototype.changeThemeColor=function(e,t,i){e||(e=MagicBoard.theme.shapeColor),t||(t=MagicBoard.theme.borderColor);for(var r=this.components.length,o=0;r>o;o++){var a=this.components[o];a.changeThemeColor(e,t)}};var ConnectorLine=function(e){var t=this;this.cInfo=e;var i=Utility.Shape.defineConnectionCoordinates(this,e);this.param={alignmentRails:!1,noGridBlock:!0},this.components=[];var r={type:"path",origDim:{},dimension:{d:i.d},param:{fill:"none",stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2,cursor:"hand"},lines:i.lines,properties:{"line-style":!0,"line-type":!0,"line-color":!0,"start-marker":!0,"end-marker":!0,"mid-marker":!0}};if(e.param&&(r.param=e.param),e.properties&&(r.properties=e.properties),e.connProp.style){var o=e.connProp.style;"DASHED"===o?r.param["stroke-dasharray"]="10,5":"DOTTED"===o?r.param["stroke-dasharray"]="1,4":"SOLID"===o&&r.param["stroke-dasharray"]&&delete r.param["stroke-dasharray"]}var a=new ShapeComponent(r);if(this.components.push(a),e.connProp.begin){var n=e.connProp.begin,s=Drawing.createArrowPath("start",n,this.cInfo.angleStart,{x:this.cInfo.pos.x1,y:this.cInfo.pos.y1},this.frame);this.components.push(s)}if(e.connProp.end){var h=e.connProp.end,s=Drawing.createArrowPath("end",h,this.cInfo.angleEnd,{x:this.cInfo.pos.x2,y:this.cInfo.pos.y2},this.frame);this.components.push(s)}this.properties=a.properties,e.events&&(this.events=e.events);var l=a.dom;l.onmouseover=function(){MagicBoard.indicators.mouseover.push(t);var e=MagicBoard.getPos(event),i=MagicBoard.sheetBook.star.style;i.display="block",i.left=e.x-10,i.top=e.y-10,MagicBoard.sheetBook.star.cLine=t},l.onmouseout=function(){event.preventDefault(),setTimeout(function(){MagicBoard.sheetBook.star.style.display="none"},300);for(var e=MagicBoard.indicators.mouseover.length-1;e>-1;e--)if(MagicBoard.indicators.mouseover[e]===t)return void MagicBoard.indicators.mouseover.splice(e,1)},this.init(),e.shape=this,e.properties=a.properties,e.param=a.param};inheritsFrom(ConnectorLine,Shape),ConnectorLine.prototype.changeThemeColor=function(e,t,i){e=MagicBoard.theme.arrowFillColor,i||(i=MagicBoard.theme.lineColor);for(var r=this.components.length,o=0;r>o;o++){var a=this.components[o];a.changeThemeColor(e,i)}},ConnectorLine.prototype.save=function(){return null},ConnectorLine.prototype.drawOnCanvas=function(e){e.beginPath();for(var t=this.components.length,i=0;t>i;i++){var r=this.components[i];if(r.drawOnCanvas(e),r.param["marker-end"]){var o=r.param["marker-end"];o="url(#fillArrowE)"===o?"Filled":"url(#hollowArrowE)"===o?"Hollow":"url(#hollowDiamond)"===o?"DiamondHollow":"url(#fillDiamond)"===o?"DiamondFilled":"url(#dot)"===o?"Dot":"Regular";var a=r.lines,n=a[a.length-1];Drawing.drawArrow(e,n.x+this.dimension.left,n.y+this.dimension.top,this.cInfo.angleEnd,o,r.param.fill,r.param.stroke)}if(r.param["marker-start"]){var o=r.param["marker-start"];o="url(#fillArrowS)"===o?"Filled":"url(#hollowArrowS)"===o?"Hollow":"url(#hollowDiamond)"===o?"DiamondHollow":"url(#fillDiamond)"===o?"DiamondFilled":"url(#dot)"===o?"Dot":"Regular";var a=r.lines,s=a[0];Drawing.drawArrow(e,s.x+this.dimension.left,s.y+this.dimension.top,this.cInfo.angleStart,o,r.param.fill,r.param.stroke)}}e.stroke()},ConnectorLine.prototype.deleteShape=function(e){var t=this.cInfo.beginShape,i=this.cInfo.endShape;MagicBoard.sheetBook.currentSheet.removeShape(this);var r=MagicBoard.sheetBook.garbage,o=this.dom.parentNode;if(r.appendChild(o),r.innerHTML="",!e){for(var a=this.currentSheet.connections,n=0,s=a.length;s>n;n++){var h=a[n];if(h.beginShape===t&&h.endShape===i){a.splice(n,1);break}}for(var l in this.cInfo)"object"==typeof this.cInfo[l]&&(this.cInfo[l]=null);for(var c=t.connectedTo,n=0,s=c.length;s>n;n++){var p=c[n];if(p===i){c.splice(n,1);break}}for(var d=i.connectedFrom,n=0,s=d.length;s>n;n++){var p=d[n];if(p===t){d.splice(n,1);break}}}for(var l in this)"object"==typeof this[l]&&(this[l]=null)};var ShapeComponent=function(e){for(var t in e)this[t]=e[t];this.parentShape=null,this.dom=document.createElementNS("http://www.w3.org/2000/svg",this.type);for(var t in this.param)"border-radius"===t?(this.dom.setAttribute("rx",this.param[t]),this.dom.setAttribute("ry",this.param[t])):this.dom.setAttribute(t,this.param[t]);this.innerHTML&&this.dom.appendChild(document.createTextNode(this.innerHTML)),this.dom.setAttribute("pointer-events","all"),this.dom.setAttribute("draggable","false"),this.dom.setAttribute("transform","translate(1,1)"),this.dom.setAttribute("name","mg"),this.derivedDimension={},this.properties||(this.properties={})};ShapeComponent.prototype.getComponentDetails=function(){var e={};return e.type=this.type,e.dimension=JSON.parse(JSON.stringify(this.dimension)),e.param=JSON.parse(JSON.stringify(this.param)),this.innerHTML&&(e.innerHTML=this.innerHTML),this.properties&&(e.properties=this.properties),e},ShapeComponent.prototype.construct=function(){if(this.parentShape){var e=this.dom;this.derivedDimension=this.calculateDimensions();for(var t in this.derivedDimension)this.dom.setAttribute(t,this.derivedDimension[t]);if("image"===this.type){var i=this.xlink;this.dom.setAttributeNS("http://www.w3.org/1999/xlink","href",i)}return e}},ShapeComponent.prototype.save=function(){var e={};for(var t in this){var i=this[t].constructor.name;("String"===i||"Object"===i)&&(e[t]=this[t])}return e},ShapeComponent.prototype.calculateDimensions=function(e,t){var i={};e||(e=0),t||(t=0);var r=0;this.param["stroke-width"]&&(r=parseInt(this.param["stroke-width"])),pw=this.parentShape.frame.width-2*r,ph=this.parentShape.frame.height-2*r;for(var o in this.dimension){var a="",n=this.dimension[o];switch(o){case"width":a=n*pw/100-2*r;break;case"x":case"x1":case"x2":case"cx":a=n*pw/100+r+e;break;case"rx":case"r":a=n*pw/100-r;break;case"height":a=n*ph/100-2*r;break;case"y":case"y1":case"y2":case"cy":a=n*ph/100+r+t;break;case"ry":a=n*ph/100-r;break;case"d":this.lines||(this.lines=[]);for(var s=n,h=s.length,l=0;h>l;l++){var c=s[l];if("Z"===c.op.toUpperCase()){a+=" Z ";break}
this.lines[l]||this.lines.push({});for(var p in c){var d=c[p];p.indexOf("x")>-1?d=Math.round(c[p]*pw/100)+e:p.indexOf("y")>-1&&(d=Math.round(c[p]*ph/100)+t),this.lines[l][p]=d,a+=d+" "}}}a&&(i[o]=a)}if("text"===this.type||"rect"===this.type){var m=this.dom;if(this.dimension.cx){var g=parseInt(m.getAttribute("cx"))-parseInt(m.getAttribute("width"))/2+e;i.x=g}if(this.dimension.cy){var y=parseInt(m.getAttribute("cy"))-parseInt(m.getAttribute("height"))/2+t;i.y=y}}return i},ShapeComponent.prototype.drawSVG=function(e,t){var i=this.dom.cloneNode(),r=this.calculateDimensions(e,t);for(var o in r){var a=r[o];i.setAttribute(o,a)}if("image"===this.type){var n=this.xlink;i.setAttributeNS("http://www.w3.org/1999/xlink","href",n)}else"text"===this.type&&(i.innerHTML=this.dom.innerHTML);return i},ShapeComponent.prototype.changeThemeColor=function(e,t){e||(e=MagicBoard.theme.shapeColor),t||(t=MagicBoard.theme.lineColor),"text"===this.type&&(e=MagicBoard.theme.textColor);var i=this.dom;e&&this.param.fill&&(this.param.fill=e,i.setAttribute("fill",e)),t&&this.param.stroke&&(this.param.stroke=t,i.setAttribute("stroke",t))},ShapeComponent.prototype.drawOnCanvas=function(e){var t=this.parentShape.dimension.left,i=this.parentShape.dimension.top,r=0;this.param["stroke-width"]&&(r=parseInt(this.param["stroke-width"]));var o=this.derivedDimension.x+t,a=this.derivedDimension.y+i;o||(o=t),a||(a=i);var n=this.param.fill;"none"===n&&(n="");var s=!1;if(this.param["stroke-dasharray"]){var h=this.param["stroke-dasharray"],l=h.split(",");e.setLineDash(l),s=!0}switch(this.type){case"rect":n?(e.fillStyle=n,e.fillRect(o,a,this.derivedDimension.width,this.derivedDimension.height)):e.strokeRect(o,a,this.derivedDimension.width,this.derivedDimension.height);break;case"circle":break;case"ellipse":var c=this.derivedDimension.cx+t,p=this.derivedDimension.cy+i;Drawing.drawEllipse(e,c,p,this.derivedDimension.rx,this.derivedDimension.ry,n,this.param.stroke);break;case"path":Drawing.drawLines(e,t,i,this.derivedDimension.d,n,this.param.stroke,r);break;case"polyline":break;case"text":n&&(e.fillStyle=n),this.param.stroke&&(e.strokeStyle=this.param.stroke),e.fillText(this.innerHTML,o,a)}s&&e.setLineDash([])},ShapeComponent.prototype.applyProperty=function(e,t,i,r,o){"attribute"===t?i?(this.dom.setAttribute(e,i),this.param[e]=i):(this.dom.removeAttribute(e),delete this.param[e]):"dom"===t&&(this.innerHTML=i,this.dom.innerHTML="",this.dom.appendChild(document.createTextNode(i)))},ShapeComponent.prototype.updateText=function(e){this.innerHTML=e,this.dom.innerHTML="",this.dom.appendChild(document.createTextNode(e))};var Drawing={};Drawing.getLineAngle=function(e,t,i,r){return Math.atan2(t-r,e-i)},Drawing.getArrowHead=function(e,t,i){var r,o,a,n,s=10;return r=e-s*Math.cos(i-Math.PI/6),a=t-s*Math.sin(i-Math.PI/6),o=e-s*Math.cos(i+Math.PI/6),n=t-s*Math.sin(i+Math.PI/6),{x1:r,x2:o,y1:a,y2:n}},Drawing.createArrowPath=function(e,t,i,r,o){var a,n,s,h,l=[],c=o.width,p=o.height,d=o.left,m=o.top,g=15;a=r.x-g*Math.cos(i-Math.PI/6),s=r.y-g*Math.sin(i-Math.PI/6),n=r.x-g*Math.cos(i+Math.PI/6),h=r.y-g*Math.sin(i+Math.PI/6);var y={properties:{}};switch(t){case"REGULAR":l[0]={op:"M",x:100*(r.x-d)/c,y:100*(r.y-m)/p},l[1]={op:"L",x:100*(a-d)/c,y:100*(s-m)/p},l[2]={op:"M",x:100*(r.x-d)/c,y:100*(r.y-m)/p},l[3]={op:"L",x:100*(n-d)/c,y:100*(h-m)/p},y.type="path",y.dimension={d:l},y.param={fill:"none",stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2};break;case"FILLED":l[0]={op:"M",x:100*(r.x-d)/c,y:100*(r.y-m)/p},l[1]={op:"L",x:100*(a-d)/c,y:100*(s-m)/p},l[2]={op:"L",x:100*(n-d)/c,y:100*(h-m)/p},l[3]={op:"L",x:100*(r.x-d)/c,y:100*(r.y-m)/p},l[4]={op:"Z"},y.type="path",y.dimension={d:l},y.param={fill:MagicBoard.theme.arrowFillColor,stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2};break;case"HOLLOW":l[0]={op:"M",x:100*(r.x-d)/c,y:100*(r.y-m)/p},l[1]={op:"L",x:100*(a-d)/c,y:100*(s-m)/p},l[2]={op:"L",x:100*(n-d)/c,y:100*(h-m)/p},l[3]={op:"L",x:100*(r.x-d)/c,y:100*(r.y-m)/p},l[4]={op:"Z"},y.type="path",y.dimension={d:l},y.param={fill:"white",stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2};break;case"DIAMONDFILLED":var u=s+h-r.y,v=a+n-r.x;l[0]={op:"M",x:100*(r.x-d)/c,y:100*(r.y-m)/p},l[1]={op:"L",x:100*(a-d)/c,y:100*(s-m)/p},l[2]={op:"L",x:100*(v-d)/c,y:100*(u-m)/p},l[3]={op:"L",x:100*(n-d)/c,y:100*(h-m)/p},l[4]={op:"L",x:100*(r.x-d)/c,y:100*(r.y-m)/p},l[5]={op:"Z"},y.type="path",y.dimension={d:l},y.param={fill:MagicBoard.theme.arrowFillColor,stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2};break;case"DIAMONDHOLLOW":var u=s+h-r.y,v=a+n-r.x;l[0]={op:"M",x:100*(r.x-d)/c,y:100*(r.y-m)/p},l[1]={op:"L",x:100*(a-d)/c,y:100*(s-m)/p},l[2]={op:"L",x:100*(v-d)/c,y:100*(u-m)/p},l[3]={op:"L",x:100*(n-d)/c,y:100*(h-m)/p},l[4]={op:"L",x:100*(r.x-d)/c,y:100*(r.y-m)/p},l[5]={op:"Z"},y.type="path",y.dimension={d:l},y.param={fill:"white",stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2};break;case"DOT":y.type="circle";var f=700/c,x=r.x-8*Math.cos(i),B=r.y-8*Math.sin(i);y.dimension={cx:100*(x-d)/c,cy:100*(B-m)/p,r:f},y.param={fill:MagicBoard.theme.shapeColor,stroke:MagicBoard.theme.lineColor,"stroke-miterlimit":"10","stroke-width":2}}var k=new ShapeComponent(y);return k},Drawing.drawArrow=function(e,t,i,r,o,a,n){o||(o="Regular"),a&&"none"!==a||(a="");var s,h,l,c,p=15;switch(s=t-p*Math.cos(r-Math.PI/6),l=i-p*Math.sin(r-Math.PI/6),h=t-p*Math.cos(r+Math.PI/6),c=i-p*Math.sin(r+Math.PI/6),e&&e.beginPath(),n&&(e.strokeStyle=n),o){case"Regular":e.moveTo(t,i),e.lineTo(s,l),e.moveTo(t,i),e.lineTo(h,c);break;case"Filled":e.moveTo(t,i),e.lineTo(s,l),e.lineTo(h,c),e.lineTo(t,i),!a&&n&&(a=n),e.fillStyle=a,e.fill();break;case"Hollow":e.moveTo(t,i),e.lineTo(s,l),e.lineTo(h,c),e.lineTo(t,i);break;case"DiamondFilled":var d=l+c-i,m=s+h-t;e.moveTo(t,i),e.lineTo(s,l),e.lineTo(m,d),e.lineTo(h,c),e.lineTo(t,i),!a&&n&&(a=n),e.fillStyle=a,e.fill();break;case"DiamondHollow":var d=l+c-i,m=s+h-t;e.moveTo(t,i),e.lineTo(s,l),e.lineTo(m,d),e.lineTo(h,c),e.lineTo(t,i);break;case"Dot":var g=t-5*Math.cos(r),y=i-5*Math.sin(r),u=5;e.arc(g,y,u,0,2*Math.PI),!a&&n&&(a=n),e.fillStyle=a,e.fill()}return e.stroke(),{x1:s,x2:h,y1:l,y2:c}},Drawing.roundRect=function(e,t,i,r,o,a,n,s){if("undefined"==typeof s&&(s=!0),"undefined"==typeof a&&(a=5),"number"==typeof a)a={tl:a,tr:a,br:a,bl:a};else{var h={tl:0,tr:0,br:0,bl:0};for(var l in h)a[l]=a[l]||h[l]}e.beginPath(),e.moveTo(t+a.tl,i),e.lineTo(t+r-a.tr,i),e.quadraticCurveTo(t+r,i,t+r,i+a.tr),e.lineTo(t+r,i+o-a.br),e.quadraticCurveTo(t+r,i+o,t+r-a.br,i+o),e.lineTo(t+a.bl,i+o),e.quadraticCurveTo(t,i+o,t,i+o-a.bl),e.lineTo(t,i+a.tl),e.quadraticCurveTo(t,i,t+a.tl,i),e.closePath(),n&&e.fill(),s&&e.stroke()},Drawing.drawEllipse=function(e,t,i,r,o,a,n){var s=t-r,h=i-o,l=2*r,c=2*o,p=.5522848,d=r*p,m=o*p,g=s+l,y=h+c;e.beginPath(),e.moveTo(s,i),e.bezierCurveTo(s,i-m,t-d,h,t,h),e.bezierCurveTo(t+d,h,g,i-m,g,i),e.bezierCurveTo(g,i+m,t+d,y,t,y),e.bezierCurveTo(t-d,y,s,i+m,s,i),a&&(e.fillStyle=a,e.fill()),n&&(e.strokeStyle=n),e.stroke()},Drawing.drawLines=function(e,t,i,r,o,a){e.beginPath(),a&&(e.strokeStyle=a);for(var n=r.split(" "),s=0,h=n.length;h>s;s++){var l=n[s++];switch(l){case"M":var c=parseInt(n[s++])+t,p=parseInt(n[s])+i;e.moveTo(c,p);break;case"L":var c=parseInt(n[s++])+t,p=parseInt(n[s])+i;e.lineTo(c,p)}}o&&(e.fillStyle=o,e.fill()),e.stroke()},document.addEventListener("dragstart",function(e){3===e.target.nodeType&&(e.preventDefault(),e.stopPropagation())},!1),MagicBoard.eventStart=function(e){var t=e.target.getAttribute("name");if(t){MagicBoard.indicators.mouseDown=!0;var i=MagicBoard.getPos(e);MagicBoard.indicators.click=i;var r=MagicBoard.indicators.mouseover.length;if(!MagicBoard.indicators.hilight&&r>0){r--;for(var o=MagicBoard.indicators.mouseover[r];o.parentShape;){var a=MagicBoard.indicators.mouseover[r--];if(!a)break;o=a}MagicBoard.indicators.lineActive=o;var n=MagicBoard.sheetBook.scratchCtx,s=MagicBoard.sheetBook.scratchCanvas;n.clearRect(0,0,s.width,s.height),n.beginPath(),n.strokeStyle="gray",n.lineWidth=1,n.setLineDash([5,5]),n.moveTo(i.x,i.y),MagicBoard.scratch.path=[i]}MagicBoard.indicators.doubleClick++,setTimeout(function(){MagicBoard.indicators.doubleClick--},400)}},MagicBoard.eventContinue=function(e){if(MagicBoard.indicators.mouseDown){var t=MagicBoard.indicators.click,i=null,r=MagicBoard.getPos(e);i=MagicBoard.indicators.hilight,i?MagicBoard.indicators.resize>-1?(i.resizeContinue(r,t),MagicBoard.indicators.resizeStarted=r):(MagicBoard.indicators.moveStarted=r,i.move(r,t)):(i=MagicBoard.indicators.lineActive,i&&(i.lineTo(r),MagicBoard.scratch.path.push(r)))}},MagicBoard.eventStop=function(e){if(MagicBoard.indicators.mouseDown){if(MagicBoard.indicators.mouseDown=!1,MagicBoard.indicators.moveStarted){var t,i,r=MagicBoard.indicators.hilight,o=MagicBoard.indicators.moveStarted,a=MagicBoard.indicators.click,n=r.getDimension(),s=o.x-a.x,h=o.y-a.y;if(MagicBoard.scratch.prevAlign){if(MagicBoard.scratch.prevAlign.left&&(i=MagicBoard.scratch.prevAlign.left),MagicBoard.scratch.prevAlign.top&&(t=MagicBoard.scratch.prevAlign.top),MagicBoard.scratch.prevAlign.right&&!MagicBoard.scratch.prevAlign.left){var l=MagicBoard.scratch.prevAlign.right-n.right;i=n.left+l}if(MagicBoard.scratch.prevAlign.bottom&&!MagicBoard.scratch.prevAlign.top){var l=MagicBoard.scratch.prevAlign.bottom-n.bottom;t=n.top+l}}i||(i=n.left+s),t||(t=n.top+h),r.setPosition({x:i,y:t,diffX:s,diffY:h}),MagicBoard.indicators.moveStarted=null,r.selectToggle()}else{var c=MagicBoard.indicators.mouseover.length;if(c>0){c--;for(var p=MagicBoard.indicators.mouseover[c];p.parentShape;){var d=MagicBoard.indicators.mouseover[c--];if(!d)break;p=d}var m=MagicBoard.indicators.lineActive;if(MagicBoard.indicators.resize>-1){var r=MagicBoard.indicators.hilight;r.resizeStop(),MagicBoard.scratch.path=[]}else m&&m!==p&&m!==p.parentShape?m.connectTo(p):MagicBoard.scratch.connectToSame?(m.connectTo(p),delete MagicBoard.scratch.connectToSame):(p.click(),MagicBoard.scratch.path=[])}else MagicBoard.indicators.lineActive?Utility.SheetBook.clearScratchCanvas():MagicBoard.indicators.resize>-1&&(r=MagicBoard.indicators.hilight,r.resizeStop())}if(MagicBoard.indicators.lineActive=null,MagicBoard.indicators.click=null,MagicBoard.indicators.doubleClick>1){var c=MagicBoard.indicators.mouseover.length;if(c>0)for(var g=0;c>g;g++){var r=MagicBoard.indicators.mouseover[g];r.doubleClick()}}}},MagicBoard.keyUp=function(e){var t=e.which;switch(e.ctrlKey?MagicBoard.indicators.keyType="ctrlKey":e.shiftKey&&(MagicBoard.indicators.keyType="shiftKey"),t){case 46:if(MagicBoard.indicators.hilight){var i=MagicBoard.indicators.hilight;i.click(),i.deleteShape()}break;case 67:case 99:"ctrlKey"===MagicBoard.indicators.keyType&&(MagicBoard.scratch.copy||(MagicBoard.scratch.copy=[]),MagicBoard.scratch.copy.push(MagicBoard.indicators.hilight));break;case 86:case 118:if("ctrlKey"===MagicBoard.indicators.keyType&&MagicBoard.scratch.copy)for(var r=MagicBoard.scratch.copy.length-1;r>-1;r--){var i=MagicBoard.scratch.copy[r],o=i.getShapeDetail(),a=new Shape(o);a.draw(),a.setPosition({x:i.dimension.right+20,y:i.dimension.top})}break;case 90:case 122:"ctrlKey"===MagicBoard.indicators.keyType&&MagicBoard.sheetBook.currentSheet.undo();break;default:return}},MagicBoard.getPos=function(e){var t,i,r=0,o=0;return e.pageX||e.pageY?(t=e.pageX-document.body.scrollLeft,i=e.pageY-document.body.scrollTop):(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,i=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),t=(t-r-MagicBoard.boardPos.x)*MagicBoard.sheetBook.zoomCompensate,i=(i-o-MagicBoard.boardPos.y)*MagicBoard.sheetBook.zoomCompensate,{x:t,y:i}};var Utility={Shape:{},Sheet:{},SheetBook:{}};Utility.SheetBook.clearScratchCanvas=function(){var e=MagicBoard.sheetBook.scratchCtx,t=MagicBoard.sheetBook.scratchCanvas;e.clearRect(0,0,t.width,t.height)},Utility.SheetBook.createWorkItems=function(e){e.connectCanvas=document.createElement("canvas"),e.connectCanvas.setAttribute("style","position:absolute;left:0px;top:0px;z-index:1;"),this.connectCtx=null,e.connectCanvas.setAttribute("name","workItem"),e.connectCanvas.height=e.cheight,e.connectCanvas.width=e.cwidth,e.connectCtx=e.connectCanvas.getContext("2d"),e.connectCtx.translate(.5,.5),e.scratchCanvas=document.createElement("canvas"),e.scratchCanvas.setAttribute("style","position:absolute;left:0px;top:0px;z-index:1;"),e.scratchCtx=null,e.scratchCanvas.setAttribute("name","workItem"),e.scratchCanvas.height=e.cheight,e.scratchCanvas.width=e.cwidth,e.scratchCtx=e.scratchCanvas.getContext("2d"),e.scratchCtx.translate(.5,.5),e.hilighter=document.createElement("div"),e.hilighter.setAttribute("style","visibility:hidden;height:100px;width:100px;left:0px;top:0px;z-index:10"),e.hilighter.setAttribute("class","hilight"),e.hilighter.setAttribute("name","workItem"),e.hilighter.onmouseover=function(){MagicBoard.indicators.hilight&&MagicBoard.indicators.mouseover.push(MagicBoard.indicators.hilight)},e.hilighter.onmouseout=function(){event.preventDefault(),MagicBoard.indicators.mouseover=[]},e.hilighter.innerHTML="<div class='stretcher' name='workItem'><div class='red' name='workItem'></div></div><div class='stretcher name='workItem''><div class='red' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='red' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='red' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='corner' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='corner' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='corner' name='workItem'></div></div><div class='stretcher' name='workItem'><div class='corner' name='workItem'></div></div>";var t=e.hilighter.children,i=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=-1)};t[0].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=0)},t[0].onmouseout=i,t[1].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=1)},t[1].onmouseout=i,t[2].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=2)},t[2].onmouseout=i,t[3].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=3)},t[3].onmouseout=i,t[4].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=4)},t[4].onmouseout=i,t[5].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=5)},t[5].onmouseout=i,t[6].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=6)},t[6].onmouseout=i,t[7].onmouseover=function(){MagicBoard.indicators.mouseDown||(MagicBoard.indicators.resize=7)},t[7].onmouseout=i,e.textEditor=document.createElement("div"),e.textEditor.setAttribute("contenteditable","true"),e.textEditor.setAttribute("style","position:absolute;left:0px;top:0px;width:10px;height:14px;display:none;background:white;z-index:100"),document.body.appendChild(e.textEditor),e.textEditor.onblur=function(){e.textEditor.style.display="none";var t=e.textEditor.targetShape;t.updateText(e.textEditor.innerHTML),t.selectToggle(),e.textEditor.targetShape=null},e.star=document.createElementNS("http://www.w3.org/2000/svg","svg"),e.star.setAttribute("style","display:none;position:absolute;left:0px;top:0px;z-index:10;width:50px;height:21px"),e.star.innerHTML='<polygon points="10,1 4,20 19,8 1,8 16,20" style="fill:red;stroke:red;stroke-width:1;fill-rule:nonzero;" />',e.star.onclick=function(){var t=e.star.cLine;t&&t.click()},Utility.SheetBook.attachWorkItems(e)},Utility.SheetBook.attachWorkItems=function(e){sheetCanvas=e.anchor,sheetCanvas.appendChild(e.scratchCanvas),sheetCanvas.appendChild(e.connectCanvas),sheetCanvas.appendChild(e.hilighter),sheetCanvas.appendChild(e.star)},Utility.SheetBook.activateHilighter=function(e,t){var i=MagicBoard.sheetBook.hilighter;i.style.visibility="visible",Utility.SheetBook.resizeHilighter(e,t)},Utility.SheetBook.resizeHilighter=function(e,t){var i=MagicBoard.sheetBook.hilighter,r=e.left-4,o=e.top-4,a=e.width+8,n=e.height+8;i.style.left=r+"px",i.style.top=o+"px",i.style.width=a+"px",i.style.height=n+"px";var s=i.children,h=s[0].style;h.left="-12px",h.top=n/2-12+"px",h.cursor="ew-resize";var l=s[1].style;l.left=a-14+"px",l.top=n/2-12+"px",l.cursor="ew-resize";var c=s[2].style;c.left=a/2-12+"px",c.top="-12px",c.cursor="ns-resize";var p=s[3].style;p.left=a/2-12+"px",p.top=n-14+"px",p.cursor="ns-resize";var d=s[4].style;d.left="-12px",d.top="-12px",d.cursor="nw-resize";var m=s[5].style;m.left="-12px",m.top=n-14+"px",m.cursor="sw-resize";var g=s[6].style;g.left=a-12+"px",g.top="-12px",g.cursor="ne-resize";var y=s[7].style;y.left=a-12+"px",y.top=n-14+"px",y.cursor="nw-resize"},Utility.SheetBook.createSheet=function(e,t){var i={name:e,shapes:[]},r=MagicBoard.sheetBook.garbage;r.innerHTML=t;var o=r.children,a=[],n=Utility.createShapeJson1(o[0],i.shapes,a,0);i.shapes.push(n);var s=new Sheet(i);return MagicBoard.sheetBook.addSheet(s),MagicBoard.sheetBook.setCurrentSheet(s),r.innerHTML="",s},Utility.supportedNodes={g:!0,rect:!0,circle:!0,ellipse:!0,path:!0,text:!0},Utility.createShapeJson1=function(e,t,i,r){for(var o=0,a=e.children.length;a>o;o++){var n=e.children[o],s=n.nodeName;if(Utility.supportedNodes[s])if("g"===s){if(i.length>0){var h=Utility.createShapeJson2(i);t.push(h)}i=[],Utility.temp={minX:99999,maxX:0,minY:99999,maxY:0},Utility.createShapeJson1(n,t,i,r+1)}else{var l={type:null,origDim:{},dimension:{},param:{},lines:[]};l.type=s;for(var c,p=0,d=n.attributes,m=d.length;m>p;p++)switch(c=d[p],c.nodeName){case"x":var g=parseInt(c.nodeValue);l.origDim.x=g,g<Utility.temp.minX&&(Utility.temp.minX=g),g>Utility.temp.maxX&&(Utility.temp.maxX=g);break;case"y":var y=parseInt(c.nodeValue);l.origDim.y=y,y<Utility.temp.minY&&(Utility.temp.minY=y),y>Utility.temp.maxY&&(Utility.temp.maxY=y);break;case"r":l.origDim.r=parseInt(c.nodeValue);break;case"cx":l.origDim.cx=parseInt(c.nodeValue);break;case"cy":l.origDim.cy=parseInt(c.nodeValue);break;case"rx":l.origDim.rx=parseFloat(c.nodeValue);break;case"ry":l.origDim.ry=parseFloat(c.nodeValue);break;case"width":l.origDim.width=parseInt(c.nodeValue);break;case"height":l.origDim.height=parseInt(c.nodeValue);break;case"d":l.lines=Utility.parseD(c.nodeValue);break;default:l.param[c.nodeName]=c.nodeValue}var u=l.origDim;if("ellipse"===l.type){var g=u.cx-u.rx;g=parseInt(g.toFixed(0));var y=u.cy-u.ry;y=parseInt(y.toFixed(0));var v=u.cx+u.rx,f=u.cy+u.ry;g<Utility.temp.minX&&(Utility.temp.minX=g),g>Utility.temp.maxX&&(Utility.temp.maxX=g),y<Utility.temp.minY&&(Utility.temp.minY=y),y>Utility.temp.maxY&&(Utility.temp.maxY=y),v<Utility.temp.minX&&(Utility.temp.minX=v),v>Utility.temp.maxX&&(Utility.temp.maxX=v),f<Utility.temp.minY&&(Utility.temp.minY=f),f>Utility.temp.maxY&&(Utility.temp.maxY=f)}else if("circle"===l.type){var g=u.cx-u.r;g=parseInt(g.toFixed(0));var y=u.cy-u.r;y=parseInt(y.toFixed(0));var v=u.cx+u.r,f=u.cy+u.r;g<Utility.temp.minX&&(Utility.temp.minX=g),g>Utility.temp.maxX&&(Utility.temp.maxX=g),y<Utility.temp.minY&&(Utility.temp.minY=y),y>Utility.temp.maxY&&(Utility.temp.maxY=y),v<Utility.temp.minX&&(Utility.temp.minX=v),v>Utility.temp.maxX&&(Utility.temp.maxX=v),f<Utility.temp.minY&&(Utility.temp.minY=f),f>Utility.temp.maxY&&(Utility.temp.maxY=f)}else if("rect"===l.type){var g=u.x,y=u.y,v=u.x+u.width,f=u.y+u.height;g<Utility.temp.minX&&(Utility.temp.minX=g),g>Utility.temp.maxX&&(Utility.temp.maxX=g),y<Utility.temp.minY&&(Utility.temp.minY=y),y>Utility.temp.maxY&&(Utility.temp.maxY=y),v<Utility.temp.minX&&(Utility.temp.minX=v),v>Utility.temp.maxX&&(Utility.temp.maxX=v),f<Utility.temp.minY&&(Utility.temp.minY=f),f>Utility.temp.maxY&&(Utility.temp.maxY=f)}else"text"===l.type&&(l.innerHTML=n.textContent);i.push(l)}}if(0===r&&i.length>0){var h=Utility.createShapeJson2(i);return h}},Utility.createShapeJson2=function(e){for(var t=Utility.temp.maxX-Utility.temp.minX,i=Utility.temp.maxY-Utility.temp.minY,r={frame:{width:t,height:i,unit:"px",left:Utility.temp.minX,top:Utility.temp.minY},param:{alignmentRails:!0},componentParms:[]},o=0,a=e.length;a>o;o++){var n=e[o],s=n.origDim,h=n.dimension;for(var l in s)switch(l){case"x":s.x=s.x-Utility.temp.minX,h.x=100*s.x/t;break;case"y":s.y=s.y-Utility.temp.minY,h.y=100*s.y/i;break;case"cx":s.cx=s.cx-Utility.temp.minX,h.cx=100*s.cx/t;break;case"cy":s.cy=s.cy-Utility.temp.minY,h.cy=100*s.cy/i;break;case"r":h.r=100*s.r/t;break;case"rx":h.rx=100*s.rx/t;break;case"ry":h.ry=100*s.ry/i;break;case"width":h.width=100*s.width/t;break;case"height":h.height=100*s.height/i}var c=n.lines;lLen=c.length,lLen&&(h.d=[]);for(var p=0;p<lLen;p++){var d=c[p],m={op:d.op};if(h.d.push(m),"Z"!==d.op)for(l in d)l.indexOf("x")>-1?(d[l]=d[l]-Utility.temp.minX,m[l]=100*d[l]/t):l.indexOf("y")>-1&&(d[l]=d[l]-Utility.temp.minY,m[l]=100*d[l]/i)}r.componentParms.push(n)}return r},Utility.parseD=function(e){for(var t=[],i=[],r=e.split(" "),o=null,a=[],n=0,s=r.length;s>n;n++){var h=r[n],l=h.substring(0,1),c=!1;if(h){var p=l.toUpperCase();switch(p){case"A":t=["rx","ry","a1","lf","sf","x","y"],i=["rx","ry","a1","lf","sf","x","y"];break;case"C":t=["x1","y1","x2","y2","x","y"],i=["x1","y1","x2","y2","x","y"];break;case"H":t=["x"],i=["x"];break;case"M":t=["x","y"],i=["x","y"];break;case"L":t=["x","y"],i=["x","y"];break;case"Q":t=["x1","y1","x","y"],i=["x1","y1","x","y"];break;case"S":t=["x2","y2","x","y"],i=["x2","y2","x","y"];break;case"T":t=["x","y"],i=["x","y"];break;case"V":t=["y"],i=["y"];break;case"Z":t=[],i=[];break;default:c=!0,h=parseInt(h)}if(c||(o={op:l},a.push(o),h.length>1&&(h=parseInt(h.substring(1)),c=!0)),c){if(0===t.length)for(var d=i.length,m=0;d>m;m++)t[m]=i[m];var g=t[0];o[g]=h,t.splice(0,1),"x"===g||"x1"===g||"x2"===g?(h<Utility.temp.minX&&(Utility.temp.minX=h),h>Utility.temp.maxX&&(Utility.temp.maxX=h)):("y"==g||"y1"==g||"y2"==g)&&(h<Utility.temp.minY&&(Utility.temp.minY=h),h>Utility.temp.maxY&&(Utility.temp.maxY=h))}}}return a},Utility.Sheet.Markers=function(e){var t="<defs><marker id='fillArrowE' markerWidth='10' markerHeight='10' refx='8' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,0 L0,6 L9,3 Z' fill='rgb(27,141,17)'></path></marker><marker id='fillArrowS' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L9,0 L9,6 Z' fill='rgb(27,141,17)'></path></marker><marker id='hollowArrowE' markerWidth='10' markerHeight='10' refx='8' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,0 L0,6 L9,3 Z' fill='white' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='hollowArrowS' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L9,0 L9,6 Z' fill='white' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='hollowDiamond' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L5,0 L10,3 L5,6 Z' fill='white' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='fillDiamond' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,3 L5,0 L10,3 L5,6 Z' fill='rgb(27,141,17)' ></path></marker><marker id='dot' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><circle r='3' cx='3' cy='3' fill='rgb(27,141,17)' ></circle></marker><marker id='lineArrowE' markerWidth='10' markerHeight='10' refx='8' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M0,0 L9,3 L0,6' fill='none' stroke='rgb(27,141,17)' stroke-width='1'></path></marker><marker id='lineArrowS' markerWidth='10' markerHeight='10' refx='0' refy='3' orient='auto' markerUnits='strokeWidth' ><path d='M9,0 L0,3 L9,6' fill='none' stroke='rgb(27,141,17)' stroke-width='1'></path></marker></defs>";e.canvas.innerHTML=t},Utility.Sheet.isGridAvailable=function(e,t,i){var r=i.dimension,o=t.courseGrids,a=o.length,n=t.noOfXcourseGrids,s=(t.noOfYcourseGrids,10),h=MagicBoard.sheetBook.cwidth,l=MagicBoard.sheetBook.cheight;if(-1===e){var c=0,p=0;r.left&&(c=r.left),e=Utility.Sheet.LeftAlignedFreeGrid(c,p,t);for(var d=e;a>d;d++){var m=o[d];if(!m.filled)return Utility.Sheet.isGridAvailable(d,t,i)}}var g=o[e],y=g.x1+s,u=g.y1+s,v={x:y,y:u},f={x:y+r.width,y:u};if(f.x>h)return Utility.Sheet.isGridAvailable(e+1,t,i);var x={x:y,y:u+r.height};if(x.y>l)return[];for(var B=({x:y+r.width,y:u+r.height},Math.floor(e/n)+1,[]),k=e;a>k;k++){var M,S,b,w,m=o[k];if(M=m.x1,S=m.x2,b=m.y1,w=m.y2,!(S<v.x||M>f.x)){if(b>x.y)break;if(!(w<v.y)){if(m.filled){for(var C=k;a>C;C++){if(C>=a)return[];if(!o[C].filled)break}var T=Utility.Sheet.isGridAvailable(C,t,i);if(T.length>0)return T}B.push(k)}}}return B},Utility.Sheet.LeftAlignedFreeGrid=function(e,t,i){var r=i.noOfXcourseGrids,o=i.courseGrids;return startGridSeq=Math.floor(t/i.courseGridSize.y)*r+Math.floor(e/i.courseGridSize.x),startGridSeq>o.length?0:o[startGridSeq].filled?e?Utility.Sheet.LeftAlignedFreeGrid(e,t+i.courseGridSize.y,i):startGridSeq++:startGridSeq},Utility.Sheet.findOwner=function(e){for(var t=MagicBoard.sheetBook.currentSheet,i=t.shapes.length,r=0;i>r;r++){var o=t.shapes[r];if(o.dom===e)return o.dom;for(var a=o.components.length,n=0;a>n;n++){var s=o.components[n];if(s.dom===e)return s}}return null},Utility.Sheet.connectIds=function(){for(var e=MagicBoard.sheetBook.currentSheet,t=e.shapes.length,i=0;t>i;i++){var r=e.shapes[i];if(r.connectedFromIds)for(var o=0,a=r.connectedFromIds.length;a>o;o++){var n=r.connectedFromIds[o];r.connectedFrom.push(Utility.Sheet.findShapeById(n))}if(r.connectedToIds)for(var o=0,a=r.connectedToIds.length;a>o;o++){var s=r.connectedToIds[o];r.connectedTo.push(Utility.Sheet.findShapeById(s))}}for(var i=0;t>i;i++){var r=e.shapes[i];r.refreshConnection()}},Utility.Sheet.findShapeById=function(e){for(var t=MagicBoard.sheetBook.currentSheet,i=t.shapes.length,r=0;i>r;r++){var o=t.shapes[r];if(o.id===e)return o}},Utility.Shape.definePeriferalPoints=function(e){e.right=e.left+e.width,e.bottom=e.top+e.height,e.cx=e.left+e.width/2,e.cy=e.top+e.height/2;var t={c1:{x:e.left,y:e.top},c2:{x:e.right,y:e.top},c3:{x:e.right,y:e.bottom},c4:{x:e.left,y:e.bottom},m12:{x:e.cx,y:e.top},m23:{x:e.right,y:e.cy},m34:{x:e.cx,y:e.bottom},m41:{x:e.left,y:e.cy}};e.edgePoints=t},Utility.Shape.resize=function(e,t,i){e.dimension.resizeX||(e.dimension.resizeX=e.dimension.left),e.dimension.resizeY||(e.dimension.resizeY=e.dimension.top);var r=e.dimension.resizeX,o=e.dimension.resizeY,a=!1,n=MagicBoard.indicators.resize;if(2>n){e.dimension.resizeWidth||(e.dimension.resizeWidth=e.dimension.width);var s=e.dimension.resizeWidth,h=s;0===MagicBoard.indicators.resize?(r+=t,h=s-t,a=!0):h=s+t,e.dimension.width=h,e.dom.setAttribute("width",h)}else if(4>n){e.dimension.resizeHeight||(e.dimension.resizeHeight=e.dimension.height);var l=e.dimension.resizeHeight,c=l;2===MagicBoard.indicators.resize?(o+=i,c=l-i,a=!0):c=l+i,e.dimension.height=c,e.dom.setAttribute("height",c)}else{e.dimension.resizeWidth||(e.dimension.resizeWidth=e.dimension.width);var s=e.dimension.resizeWidth,h=s;e.dimension.resizeHeight||(e.dimension.resizeHeight=e.dimension.height);var l=e.dimension.resizeHeight,c=l;4===n?(r+=t,h=s-t,o+=i,c=l-i,a=!0):5===n?(r+=t,h=s-t,c=l+i,a=!0):6===n?(h=s+t,o+=i,c=l-i,a=!0):7===n&&(h=s+t,c=l+i),e.dimension.width=h,e.dom.setAttribute("width",h),e.dimension.height=c,e.dom.setAttribute("height",c)}a&&e.setPosition({x:r,y:o}),e.reDraw()},Utility.Shape.applyProperty=function(){var e=document.getElementById("propPrompt"),t=e.shape;e.shape=null;for(var i=e.getElementsByClassName("prop"),r=i.length,o=0;r>o;o++){var a=i[o],n=a.getAttribute("data-dirty");if(n&&"1"===n){var s,h=a.getAttribute("data-propKey"),l=a.getAttribute("data-propType"),c=a.getAttribute("data-propName");"INPUT"===a.nodeName?s=a.value:"SELECT"===a.nodeName&&(s=a.options[a.selectedIndex].value),t.applyProperty(h,c,l,s)}}Utility.destroyDom(e,"dom")},Utility.addChangeFlag=function(){var e=event.target;e.setAttribute("data-dirty","1")},Utility.Shape.showProperty=function(){var e="",t=MagicBoard.indicators.hilight,i=t.properties;i.length;for(var r in i){var o=MagicBoard.properties[r];if("input"===o.field)e+="<label class='propLabel'>"+o.label+":</label><input class='propInput prop' data-propKey='"+r+"' class='prop' data-propType='"+o.propType+"'  data-propName='"+o.propName+"' type='"+o.values[0].type+"' value='"+o.values[0].value+"' onchange='Utility.addChangeFlag()'/><BR/>";else if("select"===o.field){e+="<label class='propLabel' >"+o.label+":</label><select onchange='Utility.addChangeFlag()' data-propKey='"+r+"' class='prop' data-propType='"+o.propType+"'  data-propName='"+o.propName+"'  >";for(var a=0,n=o.values.length;n>a;a++)e+="<option value='"+o.values[a].value+"' >"+o.values[a].name+"</option>";e+="</select><BR/>"}}if(e){e+="<br/><button class='apply button' onclick='Utility.Shape.applyProperty()'>Apply</button><button class='cancel button' onclick='Utility.destroyDom(\"propPrompt\",\"id\")'>Cancel</button>";var s=document.createElement("div");s.setAttribute("class","prompt"),s.setAttribute("style",""),s.setAttribute("id","propPrompt"),s.innerHTML=e,s.shape=t,document.body.appendChild(s)}},Utility.Shape.align=function(e){var t=MagicBoard.sheetBook.alignments.x,i=MagicBoard.sheetBook.alignments.y,r=9999,o=9999,a=e.x;nearestY=e.y;for(var n in t)if(t[n]&&t[n].length>0){var s=Math.abs(e.y-n);o>s&&(o=s,nearestY=n)}for(var h in i)if(i[h]&&i[h].length>0){var s=Math.abs(e.x-h);r>s&&(r=s,a=h)}return Math.abs(e.x-a)<20&&("string"==typeof a&&(a=parseInt(a)),e.x=a),Math.abs(e.y-nearestY)<20&&("string"==typeof nearestY&&(nearestY=parseInt(nearestY)),e.y=nearestY),e},Utility.Shape.connectTo=function(e,t,i){var r=e.events;e.parentShape&&(e=e.parentShape),t.parentShape&&(t=t.parentShape);for(var o=e.connectedTo,a=!1,n=o.length,s=0;n>s;s++){var h=o[s];if(t===h){a=!0;break}}a||(e.connectedTo.push(t),t.connectFrom(e));var l;if(a){var c=MagicBoard.sheetBook.star.cLine;l=c.cInfo,l.connProp=i}else l=Utility.Shape.calculateConnectionPoints(e,t,i);if(l){r&&r.connectTo&&r.connectTo.click&&(l.events||(l.events={}),l.events.click=r.connectTo.click);var p=MagicBoard.sheetBook.currentSheet;p.addConnections(l),p.drawConnections()}},Utility.Sheet.drawCourseGrid=function(e){var t=MagicBoard.sheetBook.scratchCtx,i=MagicBoard.sheetBook.scratchCanvas;t.clearRect(0,0,i.width,i.height),t.setLineDash([1,15]),t.beginPath();for(var r=0,o=0;o<e.noOfYcourseGrids;o++){var a=o*e.courseGridSize.y;t.moveTo(0,a),t.lineTo(MagicBoard.sheetBook.cwidth,a);for(var n=0;n<e.noOfXcourseGrids;n++){var s=n*e.courseGridSize.x;t.moveTo(s,0),t.lineTo(s,MagicBoard.sheetBook.cheight);var h="Filled "+r,l=e.courseGrids[r++];l.filled&&t.fillText(h,s+20,a+20)}}t.stroke()},Utility.Shape.blockGrids=function(e){var t=e.currentSheet,i=e.dimension,r=t.courseGrids;Utility.Shape.unblockGrids(e,r);for(var o=i.left,a=i.top,n=Math.floor(o/t.courseGridSize.x),s=Math.floor(a/t.courseGridSize.y),h=s*t.noOfXcourseGrids+n,l={x:o,y:a},c={x:o+i.width,y:a},p={x:o,y:a+i.height},r=({x:o+i.width,y:a+i.height},t.courseGrids),d=r.length,m=h;d>m;m++){var g,y,u,v,f=r[m];if(g=f.x1,y=f.x2,u=f.y1,v=f.y2,!(y<l.x||g>c.x)){if(u>p.y)break;v<l.y||(f.filled=!0,f.shapes.push(e),e.occupiedGrids.push(m))}}},Utility.Shape.unblockGrids=function(e,t){for(var i=e.occupiedGrids,r=i.length,o=0;r>o;o++){for(var a=i[o],n=t[a],s=n.shapes,h=s.length,l=0;h>l;l++){var c=s[l];if(c===e){s.splice(l,1);break}}0===s.length&&(n.filled=!1)}e.occupiedGrids=[]},Utility.Shape.reCalculateConnectionPoints=function(e){var t=e.beginShape,i=e.endShape,r=e.pos,o=r.pointStart.label,a=r.pointEnd.label,n=t.frame.edgePoints,s=i.frame.edgePoints;r.x1=n[o].x,r.y1=n[o].y,r.x2=s[a].x,r.y2=s[a].y;for(var h=e.turningPoints,l={x:r.x1,y:r.y1,angle:r.startAngle},c=0,p=h.length;p>c;c++){var d=h[c],m=l.angle;0===m?d.y=l.y:d.x=l.x,l=d}for(var d={x:r.x2,
y:r.y2},c=h.length-1;c>-1;c--){var l=h[c],m=l.angle;0===m?l.y=d.y:l.x=d.x,d=l}},Utility.Shape.calculateConnectionPoints=function(e,t,i){var r,o,a,n,s=e.getDimension(),h=t.getDimension(),l=s.edgePoints,c=h.edgePoints,p=[];if(MagicBoard.scratch.path.length>3){for(var d=Utility.identifyLines(MagicBoard.scratch.path),p=[],m=0,g=d.length;g>m;m++){var y=d[m].point;y.angle=d[m].angle,p.push(y)}p.push(MagicBoard.scratch.path[MagicBoard.scratch.path.length-1]),B=p.length;var u,v,f={};if(u=p[B-1],v=p[B-2],Utility.isIntersecting(c.c1,c.c2,u,v))f.x2=c.m12.x,f.y2=c.m12.y,f.pointEnd={label:"m12",x:f.x2,y:f.y2};else if(Utility.isIntersecting(c.c2,c.c3,u,v))f.x2=c.m23.x,f.y2=c.m23.y,f.pointEnd={label:"m23",x:f.x2,y:f.y2};else if(Utility.isIntersecting(c.c3,c.c4,u,v))f.x2=c.m34.x,f.y2=c.m34.y,f.pointEnd={label:"m34",x:f.x2,y:f.y2};else{if(!Utility.isIntersecting(c.c4,c.c1,u,v))return console.log("No endShape to connect to"),null;f.x2=c.m41.x,f.y2=c.m41.y,f.pointEnd={label:"m41",x:f.x2,y:f.y2}}if(u=p[0],v=p[1],f.angle=u.angle,Utility.isIntersecting(l.c1,l.c2,u,v))f.pointStart={},f.y1=l.m12.y,e.param.connectInPlace?f.x1=u.x:f.x1=l.m12.x,f.pointStart.label="m12",f.pointStart.x=f.x1,f.pointStart.y=f.y1;else if(Utility.isIntersecting(l.c2,l.c3,u,v))f.pointStart={},f.x1=l.m23.x,e.param.connectInPlace?f.y1=u.y:f.y1=l.m23.y,f.pointStart.label="m23",f.pointStart.x=f.x1,f.pointStart.y=f.y1;else if(Utility.isIntersecting(l.c3,l.c4,u,v))f.pointStart={},f.y1=l.m34.y,e.param.connectInPlace?f.x1=u.x:f.x1=l.m34.x,f.pointStart.label="m34",f.pointStart.x=f.x1,f.pointStart.y=f.y1;else{if(!Utility.isIntersecting(l.c4,l.c1,u,v))return console.log("No beginShape to connect from"),null;f.pointStart={},f.x1=l.m41.x,e.param.connectInPlace?f.y1=u.y:f.y1=l.m41.y,f.pointStart.label="m41",f.pointStart.x=f.x1,f.pointStart.y=f.y1}if(B=p.length,B>2){var u={x:f.x1,y:f.y1,angle:p[0].angle};p.splice(B-1,1),p.splice(0,1);for(var x=0,B=p.length;B>x;x++){var v=p[x],k=u.angle;0===k?v.y=u.y:v.x=u.x,u=v}for(var v={x:f.x2,y:f.y2},x=p.length-1;x>-1;x--){var u=p[x],k=u.angle;0===k?u.y=v.y:u.x=v.x,v=u}}else{if(2===B&&e.param.connectInPlace){var k=f.angle;90===k?f.x2=f.x1:f.y2=f.y1}p=[]}return{beginShape:e,endShape:t,pos:f,turningPoints:p,connProp:i}}var M="horiz";if(l.c1.x>c.c2.x){var S=l.m41.x-c.m23.x;if(S>50)r=l.m41.x,a=l.m41.y,o=c.m23.x,n=c.m23.y;else{var b=l.m41.y-c.m23.y,w=(l.m12.x-c.m23.x,l.m12.y-c.m23.y),C=(l.m12.x-c.m23.x,l.m12.y-c.m23.y);if(w>50)l.m12.x-c.m34.x>50?(r=l.m12.x,a=l.m12.y,o=c.m34.x,n=c.m34.y,M="vert"):(r=l.m12.x,a=l.m12.y,o=c.m23.x,n=c.m23.y,M="horizvert");else if(C>50)r=l.m34.x,a=l.m34.y,o=c.m23.x,n=c.m23.y,M="horizvert";else if(b>50){var T=l.m41.y-c.m34.y;T>50?(r=l.m41.x,a=l.m41.y,o=c.m34.x,n=c.m34.y):(r=l.m41.x,a=l.m41.y,o=c.m23.x,n=c.m23.y)}else r=l.m41.x,a=l.m41.y,o=c.m23.x,n=c.m23.y}}else if(l.c2.x<c.c1.x){var U=l.m41.x-c.m23.x;if(U>50)r=l.m23.x,a=l.m23.y,o=c.m41.x,n=c.m41.y;else{var A=(l.m23.y-c.m41.y,l.m23.x-c.m12.x,l.m23.y-c.m12.y),D=(l.m23.x-c.m34.x,l.m23.y-c.m34.y);Math.abs(D)>50?(r=l.m23.x,a=l.m23.y,D>0?(o=c.m34.x,n=c.m34.y):(o=c.m12.x,n=c.m12.y),M="horizvert"):A>50?c.m41.x-l.m23.x>50?(r=l.m23.x,a=l.m23.y,o=c.m41.x,n=c.m41.y):(r=l.m23.x,a=l.m23.y,o=c.m12.x,n=c.m12.y,M="horizvert"):(r=l.m23.x,a=l.m23.y,o=c.m41.x,n=c.m41.y)}}else l.c1.y>c.c3.y?(r=l.m12.x,a=l.m12.y,o=c.m34.x,n=c.m34.y,M="vert"):(r=l.m34.x,a=l.m34.y,o=c.m12.x,n=c.m12.y,M="vert");return{beginShape:e,endShape:t,pos:{x1:r,x2:o,y1:a,y2:n},orientation:M,connProp:i}},Utility.Shape.defineConnectionCoordinates=function(e,t){var i,r,o,a,n,s,h,l,c=t.pos,h=c.x1,l=c.y1,p=h,d=l,m=c.x2,g=c.y2;h>m&&(p=m),l>g&&(d=g),p-=10,d-=10;var y=Math.abs(c.x2-c.x1)+20,u=Math.abs(c.y2-c.y1)+20;e.frame={width:y,height:u,unit:"px",left:p,top:d};var v=((c.x1+c.x2)/2,(c.y1+c.y2)/2,[]),f=[];v.push({op:"M",x:c.x1,y:c.y1}),f.push({op:"M",x:100*(c.x1-p)/y,y:100*(c.y1-d)/u});t.connProp;if(t.turningPoints&&t.turningPoints.length>0){for(var x=c.x1,B=c.y1,k=c.x1,M=c.y1,S=t.turningPoints,b=S.length,w=0;b>w;w++){var C=S[w];C.x<x&&(x=C.x),C.y<B&&(B=C.y),C.x>k&&(k=C.x),C.y>M&&(M=C.y)}c.x2<x&&(x=c.x2),c.y2<B&&(B=c.y2),c.x2>k&&(k=c.x2),c.y2>M&&(M=c.y2),e.frame.width<k-x+20&&(e.frame.width=k-x+20,y=e.frame.width),e.frame.height<M-B+20&&(e.frame.height=M-B+20,u=e.frame.height),p>x&&(p=x-10,e.frame.left=p),d>B&&(d=B-10,e.frame.top=d),f[0]={op:"M",x:100*(c.x1-p)/y,y:100*(c.y1-d)/u};for(var w=0;b>w;w++){var C=S[w];v.push({op:"L",x:C.x,y:C.y}),f.push({op:"L",x:100*(C.x-p)/y,y:100*(C.y-d)/u})}i=Drawing.getLineAngle(c.x1,c.y1,S[0].x,S[0].y),r=Drawing.getLineAngle(c.x2,c.y2,S[b-1].x,S[b-1].y)}else i=Drawing.getLineAngle(c.x1,c.y1,c.x2,c.y2),r=Drawing.getLineAngle(c.x2,c.y2,c.x1,c.y1);return e.cInfo.angleStart=i,e.cInfo.angleEnd=r,e.cx1=o,e.cx2=a,e.cy1=n,e.cy2=s,v.push({op:"L",x:m,y:g}),f.push({op:"L",x:100*(m-p)/y,y:100*(g-d)/u}),{d:f,lines:v}},Utility.Sheet.removeConnection=function(e,t,i){for(var r=e.connections,o=r.length,a=0;o>a;a++){var n=r[a];if(n.beginShape===t&&n.endShape===i)return r.splice(a,1),void n.shape.deleteShape()}},Utility.identifyLines=function(e){var t=e.length;if(3>t)return[];for(var i=[],r={point:null,length:0,angle:null},o=e[0],a={id:0,point:o,length:0,angle:null,active:!1},n=1;t>n;n++){var s=e[n],h=Math.abs(180*Math.atan((s.y-o.y)/(s.x-o.x))/Math.PI);if(NaN!=h){if(s.angle=h,h=45*Math.round(h/45),s.curedAngle=h,a.active){var l=Math.abs(Math.abs(h)-Math.abs(a.angle));if(l>45){r.count||(r.point=s,r.angle=h,r.active=!0,r.count=0),r.count++;var c=s.x-r.point.x,p=s.y-r.point.y;r.length=Math.sqrt(c*c+p*p),r.count>6&&(i.push(a),r.id=a.id+1,a=r,a.angle=h,r={point:null,length:0,angle:null,active:!1})}else{r.active&&(r={point:null,length:0,angle:null,active:!1,count:0});var c=s.x-a.point.x,p=s.y-a.point.y;a.length=Math.sqrt(c*c+p*p)}}else a.angle=h,a.active=!0;o=s}}if(0===i.length||a.id!==i[i.length-1])if(0===i.length)i.push(a);else{var d=i[i.length-1],c=a.point.x-d.point.x,p=a.point.y-d.point.y,m=Math.sqrt(c*c+p*p);m>10&&i.push(a)}return i},Utility.Shape.dataFormatter=function(e,t,i){if(void 0==e)return 0;if("number"==typeof e)return e;if("string"==typeof e){if(e.indexOf("px")>-1)return parseInt(e.replace("px",""));if(e.indexOf("%")>-1){if(!i)return console.log(" In order to calculate %, we need the shape, that is missing in the call"),0;var r=parseInt(e.replace("%","")),o=null;if(i.parentShape)o=i.parentShape.dimension;else{var a=MagicBoard.sheetBook;o={left:0,top:0,width:a.cwidth,height:a.cheight}}var n=t;return"left"===t?n="width":"top"===t&&(n="height"),o[n]*r/100}}},Utility.Shape.recalculateDimensions=function(e){var t=e.dimension;if(t.misc.unit&&"%"===t.misc.unit)for(var i=t.misc.key,r=i.length,o=0;r>o;o++){var a=i[o],n=e.style[a],s=Utility.Shape.dataFormatter(n,a,e);t[a]=s}},Utility.isIntersecting=function(e,t,i,r){var o=function(e,t,i){return(i.y-e.y)*(t.x-e.x)>(t.y-e.y)*(i.x-e.x)};return o(e,i,r)!=o(t,i,r)&&o(e,t,i)!=o(e,t,r)},Utility.destroyDom=function(e,t){var i=MagicBoard.sheetBook.garbage,r=null;"id"===t?r=document.getElementById(e):"dom"===t&&(r=e),i.appendChild(r),i.innerHTML=""};var Logger=function(){},Info=function(){};inheritsFrom(Info,Logger),Info.prototype.console=function(e){console.log("Info - "+e)};var Warning=function(){};inheritsFrom(Warning,Logger),Warning.prototype.console=function(e){console.log("Warning - "+e)};var Error=function(){};inheritsFrom(Error,Logger),Error.prototype.console=function(e){Error.log("Error - "+e)};var info=new Info,warning=new Warning,error=new Error;
